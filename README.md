# Архитектура компьютера, 3 лабораторная
## Зинченко Антон Андреевич P3206

Вариант: alg -> asm | risc | neum | hw | instr | binary -> struct | stream | port | pstr | prob1 | cache

Базовый вариант

## Язык программирования - Алгоритмический 
```
<program> ::= <statement>
<statement> ::= "while (" <expression> ")" "{" <statement> "}"
              | "if (" <expression> ")" "{" <statement> "}" |
              | <var> " = " <expression> | <input_string> ";"
              | "let " <var> " = "  <expression> | <input_string> ";"
              | "print_int (" {expression} ");"
              | "print_str (" (<var> | "'" <string> "'") ");"

<expression> ::= <num> | <input_int> | <term> | <var>
<term> ::= "+" | "-" | "*" | "/" | "%" | "|" | "==" | "!=" | ">" | "<" 
<input_string> ::= "input_str"
<input_int> ::= "input_int"
<num> ::= -?[0-9]+
<var> ::= [a-zA-Z]*
<string> ::= [\w\s,.:;!?()\\-]+
```

## Организация памяти

Память организвана согласно модели Фон Неймана, где память данных и инструкций едина

- Память организована в виде массива байт, где машинное слово составляет 4 байта

- Доступно 8 регистров общего назначения

- Запись и Чтение из памяти осуществляется отдельными командами(load и store)

## Система команд

### Инструкции

#### Формат машинных инструкций
Все инструкции представлены в бинарном виде в формате:
```
Опкод | Тип адресации | Номер регистра(Первый операнд) | Второй операнд
00000 | 0             | 0000                           | 0000000000000000000000
```
- Тип адресации - \
если 0, значит адресация через значение в регистре \
если 1, значит адресация непосредственная

#### Инструкции с памятью
`load | type | regf | regs/val` - Загрузить значение по адресу **val**(либо лежащему в регистре **regs**) в регистр **regf**

`store | type | regr | regs/val` - Загрузить значение регистра **regf** по адресу **val**(либо лежащему в регистре **regs**)

#### Инструкции ветвления
`jump | type | - | regs/val` - Безусловный переход по адресу **val**(либо лежащему в регистре **regs**)

`jumpz | type | - | regs/val` - Безусловный переход по адресу **val**(либо лежащему в регистре **regs**) если выставлен флаг **Z**

`jumpnz | type | - | regs/val` - Безусловный переход по адресу **val**(либо лежащему в регистре **regs**) если не выставлен флаг **Z**

`jumpneg | type | - | regs/val` - Безусловный переход по адресу **val**(либо лежащему в регистре **regs**) если выставлен флаг **N**

`jumpnneg | type | - | regs/val` - Безусловный переход по адресу **val**(либо лежащему в регистре **regs**) если не выставлен флаг **N**

#### Арифметические операции
`add | type | regf | regs/val` - Сложить значения регистров **regf** и **regs**(либо **val**) и положить результат в **regf**

`sub | type | regf | regs/val` - Вычесть значения регистров **regf** и **regs**(либо **val**) и положить результат в **regf** 

`mul | type | regf | regs/val` - Перемножить значения регистров **regf** и **regs**(либо **val**) и положить результат в **regf** 

`div | type | regf | regs/val` - Поделить значения регистров **regf** и **regs**(либо **val**) и положить результат в **regf** 

`mod | type | regf | regs/val` - Получить остаток от делания значения регистров **regf** и **regs**(либо **val**) и положить результат в **regf** 

`or | type | regf | regs/val` - Выполнить операцию побитового "ИЛИ" между значениями регистров **regf** и **regs**(либо **val**) и положить результат в **regf** 

`inc | - | regf | -` - Увеличить значение регистра **regf** на 1

`dec | - | regf | -` - Уменьшить значение регистра **regf** на 1

#### Операции сравнения
`cmp | type | regf | regs/val` - Вычесть значения регистров **regf** и **regs**(либо **val**) для выставления флагов

#### Операции со стеком
`push | type | - | regs/val` - Положить на стек значение регистра **regs**(либо **val**) 

`pop | type | - | regs` - Снять со стека значение и положить в регистр **regs**

`sload | type | regf | regs/val` - Загрузить значение, лежащее по адресу суммы регистров **sp** и **regs**(либо **val**) и положить результат в регистр **regf**

#### Операции ввода-вывода
`in | - | regf | port` - Считать данные с внешнего устройства по порту **port** в регистр **regf**

`out | - | regf | port` - Отправить значение регистра **regf** на внешнее устройство по порту **port**

#### Остальные операции
`mov | type | regf | regs/val` - Загрузить значение регистра **regs**(либо **val**) в регистр **regf**

`halt | - | - | -` - Остановка процессора

## Транслятор
Интерфейс командной строки: `python translator.py <input_file> <target_file>`

Реализация представлена в [translator](./translator/)

Трансляция происходит в 2 этапа:
- Парсинг текста программы и преобразование его в последовательность токенов
- Генерация машинного кода

## Модель процессора
Интерфейс командной строки: `python main.py <target_file> <input_str_file> <input_int_file> <output_str_file> <output_int_file> <log_file>`

Реализация представлена в [processor](./CPU/)

### Middleware
![](./images/middleware.png)

На схеме представлена общая схема процессора. Схема Datapath-а и Control Unit-а приведены ниже.

Процессор разделен на 3 условные части: Datapath, Control Unit и Middleware.

Middleware включает в себя память, регистр адреса и регистр данных.

Выборка ячейки осуществляется по адресу, лежащему в регистре адреса.
Туда может быть записан результат выполнения операции в АЛУ, либо адрес из указателя инструкции(IP).

Чтение из памяти осуществляется в регистр данных, а запись из регистра данных и регистров общего назначения.

### Control Unit
![](./images/control_unit.png)

На схеме представлена модель Control Unit-а

Control Unit включает в себя декодер инструкций и указатель инструкций.

В IP может быть защелкнут результат АЛУ, инкрементированное значение IP и адрес из 2 операнда инструкции.

Битовая маска зануляет первые 10 бит инструкции, чтобы остался только 2 операнд.

### Datapath
![](./images/datapath.png)

На схеме предоставлена модель datapath

Datapath включает в себя регистры общего назначения, указатель стека и АЛУ.

Также на схеме отображен контроллер ввода-вывода.

В регистры общего назначения может быть записан результат выполнения операции в АЛУ, 
значение регистра данных(инструкция/данные), 2 операнд инструкции(также из регистра данных) и данные из IO контроллера.

На левый вход АЛУ может быть подано значение одного из регистров общего назначения, либо указателя стека.

На правый вход АЛУ может быть подано значение одного из регистров общего назначения, 
либо 2 операнд инструкции(из регистра данных).

#### Флаги
В результате выполнения операции АЛУ выставляет 2 флага:
- zero - результат операции равен нулю
- neg - результат операции отрицателен

## Тестирование
Интерфейс командной строки: `python -m pytest golden_test.py`

Реализация представлена в [golden_test](./golden_test.py)

Тестирование происходит с использование golden tests в формате yaml файлов. Тесты лежат в папке [tests](./tests/)

Тестирование реализованы в виде скрипта на Python с использованием библиотеки pytest


Каждый тест содержит в себе:
- Исходный код на высокоуровневом языке программирования
- Входные данные в json формате
- Результат работы транслятора
- Вывод программы(json файл, созданный IO контроллером)
- Журнал работы процессора

Тесты представлены для следующих программ:
- [hello](./tests/programs/hello.txt)
- [cat](./tests/programs/cat.txt)
- [hello_user](./tests/programs/hello_user.txt)
- [prob1](./tests/programs/prob1.txt)

### CI

[CI](.github/workflows/ci.yml) настроен на выполнение golden test-ов и линтера при каждом push-е в репозиторий

jobs содержит в себе 2 задачи:
- test - запускающую утилиту pytest для запуска golden test-ов
- lint - запускающую cargo check для каждого из и трейтов проекта

### Аналитика алгоритмов
```
| ФИО                      | <алг>      | <LoC> | <code байт>   | <code инстр.> | <инстр.> | вариант |
| Зинченко Антон Андреевич | hello      | 2     | 152           | 38            | 117      | (asm | risc | harv | hw | instr | struct | trap | port | cstr | prob1) |
| Зинченко Антон Андреевич | cat        | 2     | 96            | 24            | 77       | (asm | risc | harv | hw | instr | struct | trap | port | cstr | prob1) |
| Зинченко Антон Андреевич | hello_user | 4     | 204           | 51            | 148      | (asm | risc | harv | hw | instr | struct | trap | port | cstr | prob1) |
| Зинченко Антон Андреевич | prob1      | 10    | 200           | 50            | 3397     | (asm | risc | harv | hw | instr | struct | trap | port | cstr | prob1) |
```